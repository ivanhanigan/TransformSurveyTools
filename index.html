<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
               "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Transformations Survey Tools </title>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1"/>
<meta name="title" content="Transformations Survey Tools "/>
<meta name="generator" content="Org-mode"/>
<meta name="generated" content="2013-09-26T16:24+1000"/>
<meta name="author" content="Ivan Hanigan"/>
<meta name="description" content=""/>
<meta name="keywords" content=""/>
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  html { font-family: Times, serif; font-size: 12pt; }
  .title  { text-align: center; }
  .todo   { color: red; }
  .done   { color: green; }
  .tag    { background-color: #add8e6; font-weight:normal }
  .target { }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  {margin-left:auto; margin-right:0px;  text-align:right;}
  .left   {margin-left:0px;  margin-right:auto; text-align:left;}
  .center {margin-left:auto; margin-right:auto; text-align:center;}
  p.verse { margin-left: 3% }
  pre {
	border: 1pt solid #AEBDCC;
	background-color: #F3F5F7;
	padding: 5pt;
	font-family: courier, monospace;
        font-size: 90%;
        overflow:auto;
  }
  table { border-collapse: collapse; }
  td, th { vertical-align: top;  }
  th.right  { text-align:center;  }
  th.left   { text-align:center;   }
  th.center { text-align:center; }
  td.right  { text-align:right;  }
  td.left   { text-align:left;   }
  td.center { text-align:center; }
  dt { font-weight: bold; }
  div.figure { padding: 0.5em; }
  div.figure p { text-align: center; }
  div.inlinetask {
    padding:10px;
    border:2px solid gray;
    margin:10px;
    background: #ffffcc;
  }
  textarea { overflow-x: auto; }
  .linenr { font-size:smaller }
  .code-highlighted {background-color:#ffff00;}
  .org-info-js_info-navigation { border-style:none; }
  #org-info-js_console-label { font-size:10px; font-weight:bold;
                               white-space:nowrap; }
  .org-info-js_search-highlight {background-color:#ffff00; color:#000000;
                                 font-weight:bold; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>

</head>
<body>

<div id="preamble">

</div>

<div id="content">
<h1 class="title">Transformations Survey Tools </h1>


<hr/>


<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1 Introduction</a></li>
<li><a href="#sec-2">2 Background</a></li>
<li><a href="#sec-3">3 Methods</a>
<ul>
<li><a href="#sec-3-1">3.1 Classification And Regression Trees</a></li>
<li><a href="#sec-3-2">3.2 Computing-and-using-deviance-with-classification-trees</a>
<ul>
<li><a href="#sec-3-2-1">3.2.1 tree-deviance-code</a></li>
<li><a href="#sec-3-2-2">3.2.2 Reproduce the figure from the paper</a></li>
<li><a href="#sec-3-2-3">3.2.3 One row per case or using weights?</a></li>
</ul>
</li>
<li><a href="#sec-3-3">3.3 Chisquare test of deviance for Classification trees</a>
<ul>
<li><a href="#sec-3-3-1">3.3.1 R function to calculate for classification trees</a></li>
<li><a href="#sec-3-3-2">3.3.2 R-tree.chisq</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Introduction</h2>
<div class="outline-text-2" id="text-1">

</div>

</div>

<div id="outline-container-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Background</h2>
<div class="outline-text-2" id="text-2">

</div>

</div>

<div id="outline-container-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Methods</h2>
<div class="outline-text-2" id="text-3">


</div>

<div id="outline-container-3-1" class="outline-3">
<h3 id="sec-3-1"><span class="section-number-3">3.1</span> Classification And Regression Trees</h3>
<div class="outline-text-3" id="text-3-1">

</div>

</div>

<div id="outline-container-3-2" class="outline-3">
<h3 id="sec-3-2"><span class="section-number-3">3.2</span> Computing-and-using-deviance-with-classification-trees</h3>
<div class="outline-text-3" id="text-3-2">

<p>I'm reading Ritschard, G. (2006). Computing and using the deviance with classification trees. In Compstat 2006 - Proceedings in Computational Statistics 17th Symposium Held in Rome, Italy, 2006. Retrieved from <a href="http://link.springer.com/chapter/10.1007/978-3-7908-1709-6_5">http://link.springer.com/chapter/10.1007%2F978-3-7908-1709-6_5</a>
</p>
<p>
This is implemented in SPSS code. I'll try to develop R code to do these tests.
</p>
<p>
First I'll get the data out of their paper and fit the tree in figure 1
</p>

</div>

<div id="outline-container-3-2-1" class="outline-4">
<h4 id="sec-3-2-1"><span class="section-number-4">3.2.1</span> tree-deviance-code</h4>
<div class="outline-text-4" id="text-3-2-1">




<pre class="src src-R"><span style="color: #586e75;">################################################################</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">name:tree-deviance</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">func</span>
<span style="color: #268bd2; font-weight: bold;">require</span>(rpart)
<span style="color: #268bd2; font-weight: bold;">require</span>(partykit) 

<span style="color: #586e75;"># </span><span style="color: #586e75;">load</span>
civst_gend_sector  <span style="color: #268bd2; font-weight: bold;">&lt;-</span> read.csv(textConnection(<span style="color: #2aa198;">"civil_status gender activity_sector number_of_cases</span>
<span style="color: #2aa198;">         married   male         primary              50</span>
<span style="color: #2aa198;">         married   male       secondary              40</span>
<span style="color: #2aa198;">         married   male        tertiary               6</span>
<span style="color: #2aa198;">         married female         primary               0</span>
<span style="color: #2aa198;">         married female       secondary              14</span>
<span style="color: #2aa198;">         married female        tertiary              10</span>
<span style="color: #2aa198;">          single   male         primary               5</span>
<span style="color: #2aa198;">          single   male       secondary               5</span>
<span style="color: #2aa198;">          single   male        tertiary              12</span>
<span style="color: #2aa198;">          single female         primary              50</span>
<span style="color: #2aa198;">          single female       secondary              30</span>
<span style="color: #2aa198;">          single female        tertiary              18</span>
<span style="color: #2aa198;">divorced/widowed   male         primary               5</span>
<span style="color: #2aa198;">divorced/widowed   male       secondary               8</span>
<span style="color: #2aa198;">divorced/widowed   male        tertiary              10</span>
<span style="color: #2aa198;">divorced/widowed female         primary               6</span>
<span style="color: #2aa198;">divorced/widowed female       secondary               2</span>
<span style="color: #2aa198;">divorced/widowed female        tertiary               2</span>
<span style="color: #2aa198;">"</span>),sep = <span style="color: #2aa198;">""</span>)
<span style="color: #586e75;"># </span><span style="color: #586e75;">save this for use later</span>
dir.create(<span style="color: #2aa198;">"inst/extdata"</span>, recursive=T)
write.csv(civst_gend_sector, <span style="color: #2aa198;">"inst/extdata/civst_gend_sector.csv"</span>, row.names = F)
<span style="color: #586e75;"># </span><span style="color: #586e75;">clean</span>
str(civst_gend_sector)

<span style="color: #586e75;"># </span><span style="color: #586e75;">do</span>
fit <span style="color: #268bd2; font-weight: bold;">&lt;-</span> rpart(civil_status ~ gender + activity_sector,
             data = civst_gend_sector, weights = number_of_cases,
             control=rpart.control(minsplit=1))
<span style="color: #586e75;"># </span><span style="color: #586e75;">NB need minsplit to be adjusted for weights.</span>
summary(fit)

<span style="color: #586e75;"># </span><span style="color: #586e75;">report</span>
plot(fit, margin=.1)
text(fit, use.n = <span style="color: #b58900;">TRUE</span>)
title(<span style="color: #2aa198;">"fit"</span>)

<span style="color: #586e75;"># </span><span style="color: #586e75;">nicer plots</span>
png(<span style="color: #2aa198;">"images/fit1.png"</span>, 1000, 480)
plot(as.party(fit))
dev.off()  
</pre>


</div>

</div>

<div id="outline-container-3-2-2" class="outline-4">
<h4 id="sec-3-2-2"><span class="section-number-4">3.2.2</span> Reproduce the figure from the paper</h4>
<div class="outline-text-4" id="text-3-2-2">

<p>The figure in the paper can be checked against our results (and also the improved plot from the party package might be used).
</p>
<p>
<img src="images/fit1.png"  alt="images/fit1.png" />
</p></div>

</div>

<div id="outline-container-3-2-3" class="outline-4">
<h4 id="sec-3-2-3"><span class="section-number-4">3.2.3</span> One row per case or using weights?</h4>
<div class="outline-text-4" id="text-3-2-3">

<p>Using the case weights like above is convenient especially when datasets are very large, but caused problems in model fitting for me (tree failed to compute a deviance when done this way but succeeded with a dataset expanded so the data.frame is transformed into one in which each row is an observation.
</p>


<pre class="src src-R"><span style="color: #586e75;">################################################################</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">name:reassurance-re-weights</span>

<span style="color: #586e75;"># </span><span style="color: #586e75;">just to reasure myself I understand what case weights do, I'll make</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">this into a survey dataset with one row per respondent</span>
df <span style="color: #268bd2; font-weight: bold;">&lt;-</span> as.data.frame(matrix(<span style="color: #b58900;">NA</span>, nrow = 0, ncol = 3))
<span style="color: #859900; font-weight: bold;">for</span>(i <span style="color: #859900; font-weight: bold;">in</span> 1:nrow(civst_gend_sector))
    {
    <span style="color: #586e75;">#    </span><span style="color: #586e75;">i &lt;- 1</span>
        n <span style="color: #268bd2; font-weight: bold;">&lt;-</span> civst_gend_sector$number_of_cases[i]
        <span style="color: #859900; font-weight: bold;">if</span>(n == 0) <span style="color: #859900; font-weight: bold;">next</span>
        <span style="color: #859900; font-weight: bold;">for</span>(j <span style="color: #859900; font-weight: bold;">in</span> 1:n)
            {
              df <span style="color: #268bd2; font-weight: bold;">&lt;-</span> rbind(df, civst_gend_sector[i,1:3])              
            }

    }
<span style="color: #586e75;"># </span><span style="color: #586e75;">save this for use later</span>
write.csv(df, <span style="color: #2aa198;">"inst/extdata/civst_gend_sector_full.csv"</span>, row.names = F)
<span style="color: #586e75;"># </span><span style="color: #586e75;">clean</span>
nrow(df)
str(df)
fit1 <span style="color: #268bd2; font-weight: bold;">&lt;-</span> rpart(civil_status ~ gender + activity_sector, data = df)
summary(fit1)

<span style="color: #586e75;"># </span><span style="color: #586e75;">report</span>
par(mfrow=c(1,2), xpd = <span style="color: #b58900;">NA</span>) 
plot(fit)
text(fit, use.n = <span style="color: #b58900;">TRUE</span>)
title(<span style="color: #2aa198;">"fit"</span>)
plot(fit1)
text(fit1, use.n = <span style="color: #b58900;">TRUE</span>)
title(<span style="color: #2aa198;">"fit1"</span>)
<span style="color: #586e75;"># </span><span style="color: #586e75;">great these are the same which is what we'd hoped to see</span>

</pre>


</div>
</div>

</div>

<div id="outline-container-3-3" class="outline-3">
<h3 id="sec-3-3"><span class="section-number-3">3.3</span> Chisquare test of deviance for Classification trees</h3>
<div class="outline-text-3" id="text-3-3">

<p>I want to use the deviance as well as the misclassification error rate for measuring the descriptive power of the tree.  Using the tree package we can access the deviance of the fitted Classification tree.  Ripley's tree package is the only one I found to give me deviance for classification trees, the other packages only return this for regression trees.
</p>
<p>
If we look at the reduction in deviance between the Null model and the fitted tree we can say that the tree explains about XYZ% of the variation. We can also test if this is a statistically significant reduction (based on a chi-squared test), but should also comment about how much explanation this is in practical terms.
</p>




</div>

<div id="outline-container-3-3-1" class="outline-4">
<h4 id="sec-3-3-1"><span class="section-number-4">3.3.1</span> <span class="todo TODO">TODO</span> R function to calculate for classification trees</h4>
<div class="outline-text-4" id="text-3-3-1">

<p>The Ritschard (2006) paper (with SPSS code) describes a complicated method that includes Needing to retrieve for each case: 
</p><ul>
<li>leaf number and
</li>
<li>profile number
</li>
</ul>


<p>
I don't really get this, and haven't turned up many references to Ritschard since he wrote these.
</p>
<p>
So let's start simple first.  The following code follows the simpler approach:
</p><ul>
<li>Take the difference in the deviance for the models (less complex model minus more complex model)
</li>
<li>Take the difference in degrees of freedom for the models
</li>
<li>Under hypothesis that less complex (reduced) model is adequate, difference follows chi-square distribution
</li>
</ul>


</div>

</div>

<div id="outline-container-3-3-2" class="outline-4">
<h4 id="sec-3-3-2"><span class="section-number-4">3.3.2</span> R-tree.chisq</h4>
<div class="outline-text-4" id="text-3-3-2">

<ul>
<li id="sec-3-3-2-1">R code<br/>



<pre class="src src-R"><span style="color: #586e75;">################################################################</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">name:tree.chisq</span>
<span style="color: #268bd2;">tree.chisq</span> <span style="color: #268bd2; font-weight: bold;">&lt;-</span> <span style="color: #859900; font-weight: bold;">function</span>(null_model, fitted_model)
{
    <span style="color: #586e75;"># </span><span style="color: #586e75;">TODO check if these are tree model class</span>
    fit_dev  <span style="color: #268bd2; font-weight: bold;">&lt;-</span> summary(fitted_model)$dev
    null_dev  <span style="color: #268bd2; font-weight: bold;">&lt;-</span> summary(null_model)$dev    
    dev  <span style="color: #268bd2; font-weight: bold;">&lt;-</span>  null_dev - fit_dev
    df  <span style="color: #268bd2; font-weight: bold;">&lt;-</span> summary(fitted_model)$size - summary(null_model)$size
    sig  <span style="color: #268bd2; font-weight: bold;">&lt;-</span> 1 - pchisq(dev, df)
    sprintf(<span style="color: #2aa198;">"Reduction in deviance is %s percent, p-value is %s (based on a chi-squared test)"</span>,
            ((null_dev - fit_dev) / null_dev) * 100,
            sig)
}

</pre>

</li>
</ul>
<ul>
<li id="sec-3-3-2-2">test-tree.chisq<br/>



<pre class="src src-R"><span style="color: #268bd2; font-weight: bold;">require</span>(tree)

<span style="color: #586e75;"># </span><span style="color: #586e75;">load locally</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">fpath  &lt;- "inst/extdata/civst_gend_sector_full.csv"</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">or via package</span>
fpath <span style="color: #268bd2; font-weight: bold;">&lt;-</span> system.file(<span style="color: #2aa198;">"extdata"</span>, <span style="color: #2aa198;">"civst_gend_sector_full.csv"</span>, package=<span style="color: #2aa198;">"TransformSurveyTools"</span>)
civst_gend_sector  <span style="color: #268bd2; font-weight: bold;">&lt;-</span> read.csv(fpath)

<span style="color: #586e75;"># </span><span style="color: #586e75;">clean</span>
str(civst_gend_sector)

<span style="color: #586e75;"># </span><span style="color: #586e75;">do</span>
variables  <span style="color: #268bd2; font-weight: bold;">&lt;-</span> names(civst_gend_sector)
y_variable  <span style="color: #268bd2; font-weight: bold;">&lt;-</span> variables[1]
x_variables  <span style="color: #268bd2; font-weight: bold;">&lt;-</span> variables[-1]

<span style="color: #586e75;"># </span><span style="color: #586e75;">NULL</span>
form0  <span style="color: #268bd2; font-weight: bold;">&lt;-</span> reformulate(<span style="color: #2aa198;">"1"</span>,
                      response = y_variable)
form0
model0 <span style="color: #268bd2; font-weight: bold;">&lt;-</span> tree(form0, data = civst_gend_sector, method = <span style="color: #2aa198;">"class"</span>)
print(model0)
<span style="color: #586e75;"># </span><span style="color: #586e75;">FIT</span>
form1  <span style="color: #268bd2; font-weight: bold;">&lt;-</span> reformulate(x_variables,
                      response = y_variable)
form1
model1 <span style="color: #268bd2; font-weight: bold;">&lt;-</span> tree(form1, data = civst_gend_sector, method = <span style="color: #2aa198;">"class"</span>)
print(model1)
summary(model1)
plot(model1)
text(model1,pretty = 0)
tree.chisq(null_model = model0, fitted_model = model1)

</pre>



</li>
</ul>
</div>
</div>
</div>
</div>
</div>

</body>
</html>
